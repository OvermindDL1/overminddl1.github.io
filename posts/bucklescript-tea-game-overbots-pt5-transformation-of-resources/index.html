<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources | Hyperglot Programmer</title>
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en" type="text/css">
<link rel="stylesheet" href="//storage.googleapis.com/code.getmdl.io/1.1.3/material.blue_grey-blue.min.css">
<link href="../../assets/colorbox/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="alternate" type="application/atom+xml" title="Atom" href="../../index.atom">
<link rel="canonical" href="http://blog.overminddl1.com/posts/bucklescript-tea-game-overbots-pt5-transformation-of-resources/">
<meta name="description" content="Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources">
<meta name="author" content="OvermindDL1">
<link rel="prev" href="../bucklescript-tea-game-overbots-pt4-actions/" title="Bucklescript-Tea Game OverBots Pt.4 - Actions" type="text/html">
<link rel="next" href="../bucklescript-tea-game-overbots-pt6-serialization/" title="Bucklescript-Tea Game OverBots Pt.6 - Serialization" type="text/html">
<meta property="og:site_name" content="Hyperglot Programmer">
<meta property="og:title" content="Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources">
<meta property="og:url" content="http://blog.overminddl1.com/posts/bucklescript-tea-game-overbots-pt5-transformation-of-resources/">
<meta property="og:description" content="Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-05-18T06:32:30-06:00">
<meta property="article:tag" content="bucklescript">
<meta property="article:tag" content="bucklescript-tea">
<meta property="article:tag" content="overbots">
<link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="container" class="site mdl-layout mdl-js-layout
    ">
         
    <header id="header" class="mdl-layout__header site-header
    "><div class="mdl-layout__header-row site-header__title-row
        ">
            
    <h1 id="brand" class="mdl-layout__title site-title">
        <a href="http://blog.overminddl1.com/" title="Hyperglot Programmer" rel="home">
                <span id="blog-title" class="mdl-color-text--primary-contrast">Hyperglot Programmer</span>
        </a>
    </h1>

            <div class="mdl-layout-spacer"></div>
            <span class="sr-only">main navigation</span>
            <nav class="mdl-navigation site-header__navigation"><a class="mdl-navigation__link" href="../../archives/">Archive</a>
                      <a class="mdl-navigation__link" href="../../categories/">Categories</a>
                      <a class="mdl-navigation__link" href="../../tags/">Tags</a>
                      <a class="mdl-navigation__link" href="../../rss.xml">RSS feed</a>
              
              
            </nav><div class="site-header__search" role="search">
                    
<!-- Google custom search -->
<form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
  <input class="mdl-textfield__input" type="search" id="searchinput"><label class="mdl-textfield__label mdl-color-text--blue-50" for="searchinput">Search...</label>
</div>
<input type="hidden" name="sitesearch" value="http://blog.overminddl1.com/">
</form>
<!-- End of custom search -->

                </div>
            

        </div>
    </header><div id="drawer" class="mdl-layout__drawer site-drawer
mdl-layout--small-screen-only
    ">
        <div class="mdl-layout__title site-drawer__title">
                <span>Hyperglot Programmer</span>
        </div>
        <div class="site-drawer__description">
            
<!-- Google custom search -->
<form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
  <input class="mdl-textfield__input" type="search" id="searchinput"><label class="mdl-textfield__label " for="searchinput">Search...</label>
</div>
<input type="hidden" name="sitesearch" value="http://blog.overminddl1.com/">
</form>
<!-- End of custom search -->

        </div>
        <span class="sr-only">side navigation</span>
        <nav class="mdl-navigation site-drawer__navigation"><a class="mdl-navigation__link" href="../../archives/">Archive</a>
                    <a class="mdl-navigation__link" href="../../categories/">Categories</a>
                    <a class="mdl-navigation__link" href="../../tags/">Tags</a>
                    <a class="mdl-navigation__link" href="../../rss.xml">RSS feed</a>
            
            
        </nav>
</div>

    

         <main id="content" class="mdl-layout__content"><div class="site-post site-card mdl-grid">
    <div class="mdl-card mdl-cell mdl-cell--12-col
    site-post-code
    mdl-shadow--4dp
">
        <article class="h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><div class="mdl-card__media"></div>
            
    
    <div class="mdl-card__title">
        <h1 class="mdl-card__title-text p-name entry-title" itemprop="headline name">Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources</h1>
    </div>

    <meta name="description" itemprop="description" content="Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources">
<div class="mdl-card__supporting-text e-content entry-content" itemprop="articleBody text">
                <div>
<p>Transformers of Resources are the things that can be enabled or disabled and then either consume, generate, or both a set of resources atomically.  Time to write them.</p>
<!-- TEASER_END -->
<div class="section" id="transformer-type">
<h2>Transformer type</h2>
<p>I want to use modules for this one as well to show how to define a module that uses a type, and yet you want to store that module 'inside' of that type.  In this case I want a cache of the transformers in the model (that will not be serialized out when we do saving later) for quick calculations, and yet the module needs to reference the model as well to be able to test flags and more.</p>
<p>To accomplish this I will first define a module with an 'unknown' model type in <tt class="docutils literal">src/overbots_types.ml</tt>:</p>
<pre class="code ocaml"><a name="rest_code_992852e911dc43a3b1e1c38b977d78bb-1"></a><span class="k">module</span> <span class="k">type</span> <span class="nc">UTransformer</span> <span class="o">=</span> <span class="k">sig</span>
<a name="rest_code_992852e911dc43a3b1e1c38b977d78bb-2"></a>  <span class="k">type</span> <span class="n">model</span>
<a name="rest_code_992852e911dc43a3b1e1c38b977d78bb-3"></a>  <span class="k">val</span> <span class="n">name</span> <span class="o">:</span> <span class="n">model</span> <span class="o">-&gt;</span> <span class="kt">string</span>
<a name="rest_code_992852e911dc43a3b1e1c38b977d78bb-4"></a>  <span class="k">val</span> <span class="n">enabled</span> <span class="o">:</span> <span class="n">model</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
<a name="rest_code_992852e911dc43a3b1e1c38b977d78bb-5"></a>  <span class="k">val</span> <span class="n">transformers</span> <span class="o">:</span> <span class="n">model</span> <span class="o">-&gt;</span> <span class="n">resource_transformations</span>
<a name="rest_code_992852e911dc43a3b1e1c38b977d78bb-6"></a><span class="k">end</span>
</pre>
<p>I placed in an unbound type binding named <tt class="docutils literal">model</tt> that has to be refined later when the signature is reified.  I then change the model type to define a cache and put the transformer in it, refining the signature <tt class="docutils literal">model</tt> type to the actual model:</p>
<pre class="code ocaml"><a name="rest_code_a55d42b381dd429b9508160740d92a8e-1"></a><span class="k">type</span> <span class="n">cache</span> <span class="o">=</span> <span class="o">{</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-2"></a>  <span class="n">transformers</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">UTransformer</span> <span class="k">with</span> <span class="k">type</span> <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">)</span> <span class="kt">list</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-3"></a>  <span class="n">resource_deltas</span> <span class="o">:</span> <span class="n">resource_value</span> <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-4"></a><span class="o">}</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-5"></a><span class="ow">and</span> <span class="n">model</span> <span class="o">=</span> <span class="o">{</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-6"></a>  <span class="n">start_realtime</span> <span class="o">:</span> <span class="nn">Tea</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-7"></a>  <span class="n">current_realtime</span> <span class="o">:</span> <span class="nn">Tea</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-8"></a>  <span class="n">gametime</span> <span class="o">:</span> <span class="nn">Tea</span><span class="p">.</span><span class="nn">Time</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-9"></a>  <span class="n">msgs</span> <span class="o">:</span> <span class="n">game_msg</span> <span class="kt">list</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-10"></a>  <span class="n">resource_values</span> <span class="o">:</span> <span class="n">resource_value</span> <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-11"></a>  <span class="n">bool_flags</span> <span class="o">:</span> <span class="n">bool_flags</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-12"></a>  <span class="n">int_flags</span> <span class="o">:</span> <span class="n">int_flags</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-13"></a>  <span class="n">float_flags</span> <span class="o">:</span> <span class="n">float_flags</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-14"></a>  <span class="n">cache</span> <span class="o">:</span> <span class="n">cache</span><span class="o">;</span>
<a name="rest_code_a55d42b381dd429b9508160740d92a8e-15"></a><span class="o">}</span>
</pre>
<p>I define the cache, which needs to reference the model, so I 'and' it with the model type so they can be recursive where the model references the cache.  The cache's <tt class="docutils literal">transformers</tt> entry is a list of transformer modules, I'll clear it anytime I need to rebuild the cache of transformers.  To help typecheck better at location I'm also going to define a specific <tt class="docutils literal">Transformer</tt> module as well after the model of:</p>
<pre class="code ocaml"><a name="rest_code_f1cbd923ef7741fa8523b621c3943b43-1"></a><span class="k">module</span> <span class="k">type</span> <span class="nc">Transformer</span> <span class="o">=</span> <span class="nc">UTransformer</span> <span class="k">with</span> <span class="k">type</span> <span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</pre>
<p>Then in a new source file of <tt class="docutils literal">src/overbots_transformers.ml</tt> and I'll start by defining a couple transformers to test:</p>
<pre class="code ocaml"><a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-1"></a><span class="k">module</span> <span class="nc">BaseSolarGeneration</span> <span class="o">:</span> <span class="nc">Transformer</span> <span class="o">=</span> <span class="k">struct</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-2"></a>  <span class="k">type</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">Overbots_types</span><span class="p">.</span><span class="n">model</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-3"></a>  <span class="k">let</span> <span class="n">name</span> <span class="o">_</span><span class="n">model</span> <span class="o">=</span> <span class="s2">"Sunlight"</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-4"></a>  <span class="k">let</span> <span class="n">enabled</span> <span class="o">_</span><span class="n">model</span> <span class="o">=</span> <span class="bp">true</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-5"></a>  <span class="k">let</span> <span class="n">transformers</span> <span class="n">model</span> <span class="o">=</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-6"></a>    <span class="o">[</span> <span class="nc">Generate</span> <span class="o">(</span><span class="nc">Energy</span><span class="o">,</span> <span class="n">float_flag_value</span> <span class="nc">BasicSolarPanelSelfGeneration</span> <span class="n">model</span><span class="o">)</span> <span class="o">]</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-7"></a><span class="k">end</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-8"></a>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-9"></a><span class="k">module</span> <span class="nc">DrillEnabled</span> <span class="o">:</span> <span class="nc">Transformer</span> <span class="o">=</span> <span class="k">struct</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-10"></a>  <span class="k">type</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">Overbots_types</span><span class="p">.</span><span class="n">model</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-11"></a>  <span class="k">let</span> <span class="n">name</span> <span class="o">_</span><span class="n">model</span> <span class="o">=</span> <span class="s2">"Internal Drilling"</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-12"></a>  <span class="k">let</span> <span class="n">enabled</span> <span class="n">model</span> <span class="o">=</span> <span class="n">bool_flag_exists</span> <span class="nc">DrillDeployed</span> <span class="n">model</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-13"></a>  <span class="k">let</span> <span class="n">transformers</span> <span class="o">_</span><span class="n">model</span> <span class="o">=</span> <span class="o">[</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-14"></a>    <span class="nc">Consume</span> <span class="o">(</span><span class="nc">Energy</span><span class="o">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="o">);</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-15"></a>    <span class="nc">Generate</span> <span class="o">(</span><span class="nc">IronOxide</span><span class="o">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="o">);</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-16"></a>    <span class="nc">Generate</span> <span class="o">(</span><span class="nc">RawSilicon</span><span class="o">,</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">);</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-17"></a>  <span class="o">]</span>
<a name="rest_code_c41ffcbb5cbe40a6ae22accc7884e20f-18"></a><span class="k">end</span>
</pre>
<p>And I'll pack them for ease of iteration:</p>
<pre class="code ocaml"><a name="rest_code_5ba29a2b7a10441d87a9923f6f40eb7d-1"></a><span class="k">let</span> <span class="n">all_transformers</span> <span class="o">=</span> <span class="o">[</span>
<a name="rest_code_5ba29a2b7a10441d87a9923f6f40eb7d-2"></a>  <span class="o">(</span><span class="k">module</span> <span class="nc">BaseSolarGeneration</span> <span class="o">:</span> <span class="nc">Transformer</span><span class="o">);</span>
<a name="rest_code_5ba29a2b7a10441d87a9923f6f40eb7d-3"></a>  <span class="o">(</span><span class="k">module</span> <span class="nc">DrillEnabled</span><span class="o">);</span>
<a name="rest_code_5ba29a2b7a10441d87a9923f6f40eb7d-4"></a><span class="o">]</span>
</pre>
<p>And to get a feel for how to process them, let's write a helper that I know I'll need:</p>
<pre class="code ocaml"><a name="rest_code_3e52c8ef05b341e684beeb3732219319-1"></a><span class="k">let</span> <span class="n">enabled_transformers</span> <span class="n">model</span> <span class="o">=</span>
<a name="rest_code_3e52c8ef05b341e684beeb3732219319-2"></a>  <span class="n">all_transformers</span>
<a name="rest_code_3e52c8ef05b341e684beeb3732219319-3"></a>  <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="k">module</span> <span class="nc">T</span> <span class="o">:</span> <span class="nc">Transformer</span><span class="o">)</span> <span class="o">-&gt;</span>
<a name="rest_code_3e52c8ef05b341e684beeb3732219319-4"></a>      <span class="nn">T</span><span class="p">.</span><span class="n">enabled</span> <span class="n">model</span>
<a name="rest_code_3e52c8ef05b341e684beeb3732219319-5"></a>    <span class="o">)</span>
</pre>
<p>This just takes the <tt class="docutils literal">all_transformers</tt> list and filters out all the ones that are not enabled based on the state of the model and returns that new list.</p>
<p>I know I will need to process this in the update tick so let's go ahead and add that scaffolding now:</p>
<pre class="code ocaml"><a name="rest_code_6e196eedd0ad4a4aaf9b5cffa1e17752-1"></a><span class="k">let</span> <span class="n">update_transformations</span> <span class="n">model</span> <span class="n">new_time</span> <span class="o">=</span>
<a name="rest_code_6e196eedd0ad4a4aaf9b5cffa1e17752-2"></a>  <span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="nn">Tea</span><span class="p">.</span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span>
</pre>
<p>I'm also going to update the <tt class="docutils literal">init</tt> function in <tt class="docutils literal">src/overbots.ml</tt> by adding the cache entry thus changing it all to:</p>
<pre class="code ocaml"><a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-1"></a><span class="k">let</span> <span class="n">init</span> <span class="bp">()</span> <span class="o">=</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-2"></a>  <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="o">{</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-3"></a>    <span class="n">start_realtime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-4"></a>    <span class="n">current_realtime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-5"></a>    <span class="n">gametime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-6"></a>    <span class="n">msgs</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-7"></a>    <span class="n">resource_values</span> <span class="o">=</span> <span class="nn">Overbots_resource</span><span class="p">.</span><span class="n">init_resources_values</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-8"></a>    <span class="n">bool_flags</span> <span class="o">=</span> <span class="n">init_bool_flags</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-9"></a>    <span class="n">int_flags</span> <span class="o">=</span> <span class="n">init_int_flags</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-10"></a>    <span class="n">float_flags</span> <span class="o">=</span> <span class="n">init_float_flags</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-11"></a>    <span class="n">cache</span> <span class="o">=</span> <span class="o">{</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-12"></a>      <span class="n">transformers</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-13"></a>      <span class="n">resource_deltas</span> <span class="o">=</span> <span class="nn">Overbots_resource</span><span class="p">.</span><span class="n">init_resources_values</span><span class="o">;</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-14"></a>    <span class="o">};</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-15"></a>  <span class="o">}</span> <span class="k">in</span>
<a name="rest_code_df3c4d1d966a433fa4b73fc028ae4350-16"></a>  <span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span>
</pre>
<p>And lastly to get it getting called if not doing anything yet I'm going to add its call to <tt class="docutils literal">update_state</tt> in <tt class="docutils literal">src/overbots_update.ml</tt> to become:</p>
<pre class="code ocaml"><a name="rest_code_2f784d6cbe704933867a85ea7f9ee197-1"></a><span class="k">let</span> <span class="n">update_state</span> <span class="n">model</span> <span class="n">new_time</span> <span class="o">=</span>
<a name="rest_code_2f784d6cbe704933867a85ea7f9ee197-2"></a>  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">new_time</span> <span class="o">-.</span> <span class="n">model</span><span class="o">.</span><span class="n">start_realtime</span> <span class="k">in</span>
<a name="rest_code_2f784d6cbe704933867a85ea7f9ee197-3"></a>  <span class="k">let</span> <span class="n">model</span><span class="o">,</span> <span class="n">ta_cmds</span> <span class="o">=</span> <span class="nn">Overbots_actions</span><span class="p">.</span><span class="n">update_timeactions</span> <span class="n">model</span> <span class="n">time</span> <span class="k">in</span>
<a name="rest_code_2f784d6cbe704933867a85ea7f9ee197-4"></a>  <span class="k">let</span> <span class="n">model</span><span class="o">,</span> <span class="n">t_cmds</span> <span class="o">=</span> <span class="nn">Overbots_transformers</span><span class="p">.</span><span class="n">update_transformations</span> <span class="n">model</span> <span class="n">time</span> <span class="k">in</span>
<a name="rest_code_2f784d6cbe704933867a85ea7f9ee197-5"></a>  <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="o">{</span><span class="n">model</span> <span class="k">with</span> <span class="n">gametime</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span> <span class="n">current_realtime</span> <span class="o">=</span> <span class="n">new_time</span><span class="o">}</span> <span class="k">in</span>
<a name="rest_code_2f784d6cbe704933867a85ea7f9ee197-6"></a>  <span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">batch</span> <span class="o">[</span><span class="n">ta_cmds</span><span class="o">;</span> <span class="n">t_cmds</span><span class="o">])</span>
</pre>
<p>So now it is time to fill out <tt class="docutils literal">update_transformations</tt>, which is the second big system in an incremental game.  This will need to take the listed transformers and get a list of changes to each resource to generate the overall change-per-second, then calculate the ticks up to when the next one fills up then repeat or until the timeslice is elapsed then return.  So I start with just saying how I want to transform the data between the types here to get an idea of how I want to accomplish this:</p>
<pre class="code ocaml"><a name="rest_code_711fd47ce0314f9b9b43103696b013a2-1"></a><span class="k">let</span> <span class="k">rec</span> <span class="n">update_transformations</span> <span class="n">model</span> <span class="n">new_time</span> <span class="o">=</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-2"></a>  <span class="k">let</span> <span class="n">transformers</span><span class="o">,</span> <span class="n">resource_deltas</span> <span class="o">=</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-3"></a>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">transformers</span> <span class="o">==</span> <span class="bp">[]</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-4"></a>    <span class="k">then</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-5"></a>      <span class="k">let</span> <span class="n">transformers</span> <span class="o">=</span> <span class="n">enabled_transformers</span> <span class="n">model</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-6"></a>      <span class="n">transformers</span><span class="o">,</span> <span class="n">calculate_resource_deltas</span> <span class="n">model</span> <span class="n">transformers</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-7"></a>    <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">transformers</span><span class="o">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">resource_deltas</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-8"></a>    <span class="k">let</span> <span class="n">time_to_next_filled</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">gametime</span> <span class="o">+.</span> <span class="n">calculate_deltas_to_next_filled</span> <span class="n">model</span> <span class="n">resource_deltas</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-9"></a>  <span class="k">let</span> <span class="n">time_slice</span> <span class="o">=</span> <span class="n">min</span> <span class="n">time_to_next_filled</span> <span class="n">new_time</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-10"></a>  <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="n">apply_resource_deltas</span> <span class="n">model</span> <span class="n">resource_deltas</span> <span class="n">time_slice</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-11"></a>  <span class="k">if</span> <span class="n">time_slice</span> <span class="o">&gt;=</span> <span class="n">new_time</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-12"></a>  <span class="k">then</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-13"></a>    <span class="k">let</span> <span class="n">gametime</span> <span class="o">=</span> <span class="n">new_time</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-14"></a>    <span class="k">let</span> <span class="n">cache</span> <span class="o">=</span> <span class="o">{</span><span class="n">model</span><span class="o">.</span><span class="n">cache</span> <span class="k">with</span> <span class="n">transformers</span><span class="o">;</span> <span class="n">resource_deltas</span><span class="o">}</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-15"></a>    <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="o">{</span><span class="n">model</span> <span class="k">with</span> <span class="n">gametime</span><span class="o">;</span> <span class="n">cache</span><span class="o">}</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-16"></a>    <span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="nn">Tea</span><span class="p">.</span><span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-17"></a>  <span class="k">else</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-18"></a>    <span class="k">let</span> <span class="n">gametime</span> <span class="o">=</span> <span class="n">time_slice</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-19"></a>    <span class="k">let</span> <span class="n">cache</span> <span class="o">=</span> <span class="o">{</span><span class="n">model</span><span class="o">.</span><span class="n">cache</span> <span class="k">with</span> <span class="n">transformers</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span> <span class="n">resource_deltas</span> <span class="o">=</span> <span class="nn">Overbots_resource</span><span class="p">.</span><span class="n">init_resources_values</span><span class="o">}</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-20"></a>    <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="o">{</span><span class="n">model</span> <span class="k">with</span> <span class="n">gametime</span><span class="o">;</span> <span class="n">cache</span><span class="o">}</span> <span class="k">in</span>
<a name="rest_code_711fd47ce0314f9b9b43103696b013a2-21"></a>    <span class="n">update_transformations</span> <span class="n">model</span> <span class="n">new_time</span>
</pre>
<p>So I have a basic structure, not really happy with it, but can alway change it up later, however I need to fulfill three functions then, I'll start with the first of <tt class="docutils literal">calculate_resource_deltas</tt>:</p>
<pre class="code ocaml"><a name="rest_code_89a935bc7a7c46af91c99c52702f3443-1"></a><span class="k">let</span> <span class="n">calculate_resource_delta</span> <span class="n">model</span> <span class="n">map</span> <span class="o">(</span><span class="k">module</span> <span class="nc">T</span> <span class="o">:</span> <span class="nc">Transformer</span><span class="o">)</span> <span class="o">=</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-2"></a>  <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="o">(</span><span class="k">fun</span> <span class="n">map</span> <span class="n">transformation</span> <span class="o">-&gt;</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-3"></a>      <span class="k">let</span> <span class="n">rid</span><span class="o">,</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">transformer_delta</span> <span class="n">transformation</span> <span class="k">in</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-4"></a>      <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">+.</span> <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">find</span> <span class="n">rid</span> <span class="n">map</span> <span class="k">in</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-5"></a>      <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">add</span> <span class="n">rid</span> <span class="n">delta</span> <span class="n">map</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-6"></a>    <span class="o">)</span> <span class="n">map</span> <span class="o">(</span><span class="nn">T</span><span class="p">.</span><span class="n">transformers</span> <span class="n">model</span><span class="o">)</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-7"></a>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-8"></a><span class="k">let</span> <span class="n">calculate_resource_deltas</span> <span class="n">model</span> <span class="n">transformers</span> <span class="o">=</span>
<a name="rest_code_89a935bc7a7c46af91c99c52702f3443-9"></a>  <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="o">(</span><span class="n">calculate_resource_delta</span> <span class="n">model</span><span class="o">)</span> <span class="n">init_resources_values</span> <span class="n">transformers</span>
</pre>
<p>That ended up being pretty easy, now to <tt class="docutils literal">calculate_deltas_to_next_filled</tt>:</p>
<pre class="code ocaml"><a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-1"></a><span class="k">let</span> <span class="n">calculate_delta_to_next_filled</span> <span class="n">model</span> <span class="n">rid</span> <span class="n">delta</span> <span class="n">old_time</span> <span class="o">=</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-2"></a>    <span class="k">if</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">then</span> <span class="n">old_time</span> <span class="k">else</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-3"></a>    <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">find</span> <span class="n">rid</span> <span class="n">model</span><span class="o">.</span><span class="n">resource_values</span> <span class="k">in</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-4"></a>    <span class="k">let</span> <span class="k">module</span> <span class="nc">R</span> <span class="o">=</span> <span class="o">(</span><span class="k">val</span> <span class="n">get_resource_module</span> <span class="n">rid</span><span class="o">)</span> <span class="k">in</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-5"></a>    <span class="k">let</span> <span class="n">rmin</span><span class="o">,</span> <span class="n">rmax</span> <span class="o">=</span> <span class="nn">R</span><span class="p">.</span><span class="n">get_value_range</span> <span class="n">model</span> <span class="k">in</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-6"></a>    <span class="k">if</span> <span class="k">value</span> <span class="o">&gt;=</span> <span class="n">rmax</span> <span class="o">||</span> <span class="k">value</span> <span class="o">&lt;=</span> <span class="n">rmin</span> <span class="k">then</span> <span class="n">old_time</span> <span class="k">else</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-7"></a>    <span class="k">let</span> <span class="n">at_time</span> <span class="o">=</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="n">rmax</span><span class="o">-.</span><span class="k">value</span><span class="o">)</span> <span class="o">/.</span> <span class="n">delta</span> <span class="k">else</span> <span class="o">(</span><span class="k">value</span><span class="o">-.</span><span class="n">rmin</span><span class="o">)</span> <span class="o">/.</span> <span class="n">delta</span> <span class="k">in</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-8"></a>    <span class="k">if</span> <span class="n">at_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">at_time</span> <span class="o">&lt;</span> <span class="n">old_time</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-9"></a>    <span class="k">then</span> <span class="n">at_time</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-10"></a>    <span class="k">else</span> <span class="n">old_time</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-11"></a>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-12"></a><span class="k">let</span> <span class="n">calculate_deltas_to_next_filled</span> <span class="n">model</span> <span class="n">resource_deltas</span> <span class="o">=</span>
<a name="rest_code_4ee09177c9d740c3bfe47a777d3e7117-13"></a>  <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="n">calculate_delta_to_next_filled</span> <span class="n">model</span><span class="o">)</span> <span class="n">resource_deltas</span> <span class="n">max_float</span>
</pre>
<p>So this will get the next time when a storage is emptied/capped.  And lastly the function <tt class="docutils literal">apply_resource_deltas</tt>:</p>
<pre class="code ocaml"><a name="rest_code_230bb8837c334745b576a8299407ddfa-1"></a><span class="k">let</span> <span class="n">apply_resource_deltas</span> <span class="n">model</span> <span class="n">resource_deltas</span> <span class="n">cur_time</span> <span class="o">=</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-2"></a>  <span class="k">let</span> <span class="n">time_delta</span> <span class="o">=</span> <span class="n">cur_time</span> <span class="o">-.</span> <span class="n">model</span><span class="o">.</span><span class="n">gametime</span> <span class="k">in</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-3"></a>  <span class="nn">ResourceMap</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">rid</span> <span class="n">delta</span> <span class="n">model</span> <span class="o">-&gt;</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-4"></a>      <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">*.</span> <span class="n">time_delta</span> <span class="k">in</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-5"></a>      <span class="k">match</span> <span class="n">add_resource_value</span> <span class="n">rid</span> <span class="n">delta</span> <span class="n">model</span> <span class="k">with</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-6"></a>      <span class="o">|</span> <span class="nc">ValueTooLow</span> <span class="o">-&gt;</span> <span class="n">model</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-7"></a>      <span class="o">|</span> <span class="nc">ValueTooHigh</span> <span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="o">_</span><span class="n">overrage</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">model</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-8"></a>      <span class="o">|</span> <span class="nc">ValueSuccess</span> <span class="n">model</span> <span class="o">-&gt;</span> <span class="n">model</span>
<a name="rest_code_230bb8837c334745b576a8299407ddfa-9"></a>    <span class="o">)</span> <span class="n">resource_deltas</span> <span class="n">model</span>
</pre>
<p>And with that it compiles again.  Plenty of opportunity to optimize but it is fine for now.</p>
<p>I also want to see what the delta is, hence the main reason I cached it, so I'm changing the <tt class="docutils literal">view_resource</tt> function in <tt class="docutils literal">src/overbots_view.ml</tt> to be:</p>
<pre class="code ocaml"><a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-1"></a><span class="k">let</span> <span class="n">view_resources_category_resource</span> <span class="n">model</span> <span class="o">(</span><span class="n">rid</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span> <span class="o">=</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-2"></a>  <span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="nn">Overbots_resource</span><span class="p">.</span><span class="n">get_resource_module</span> <span class="n">rid</span> <span class="k">in</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-3"></a>  <span class="k">let</span> <span class="k">module</span> <span class="nc">R</span> <span class="o">=</span> <span class="o">(</span><span class="k">val</span> <span class="n">r</span><span class="o">)</span> <span class="k">in</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-4"></a>  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">R</span><span class="p">.</span><span class="n">shown</span> <span class="n">model</span><span class="o">)</span> <span class="k">then</span> <span class="bp">[]</span> <span class="k">else</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-5"></a>  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="n">format_value</span> <span class="o">(</span><span class="nn">Overbots_resource</span><span class="p">.</span><span class="n">get_resource_value</span> <span class="n">rid</span> <span class="n">model</span><span class="o">)</span> <span class="k">in</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-6"></a>  <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">format_value</span> <span class="o">(</span><span class="nn">ResourceMap</span><span class="p">.</span><span class="n">find</span> <span class="n">rid</span> <span class="n">model</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">resource_deltas</span><span class="o">)</span> <span class="k">in</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-7"></a>  <span class="o">[</span> <span class="n">div</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-8"></a>      <span class="o">[</span> <span class="k">class'</span> <span class="o">(</span><span class="s2">"resource resource-"</span><span class="o">^</span><span class="n">id</span><span class="o">)</span> <span class="o">]</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-9"></a>      <span class="o">[</span> <span class="n">div</span> <span class="o">[</span> <span class="k">class'</span> <span class="s2">"resource-name"</span> <span class="o">]</span> <span class="o">[</span> <span class="n">text</span> <span class="n">name</span> <span class="o">]</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-10"></a>      <span class="o">;</span> <span class="n">div</span> <span class="o">[</span> <span class="k">class'</span> <span class="s2">"resource-value"</span> <span class="o">]</span> <span class="o">[</span> <span class="n">text</span> <span class="k">value</span> <span class="o">]</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-11"></a>      <span class="o">;</span> <span class="n">div</span> <span class="o">[</span> <span class="k">class'</span> <span class="s2">"resource-delta"</span> <span class="o">]</span> <span class="o">[</span> <span class="n">text</span> <span class="n">delta</span><span class="o">;</span> <span class="n">text</span> <span class="s2">"/s"</span> <span class="o">]</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-12"></a>      <span class="o">]</span>
<a name="rest_code_cd21deaf2f814f89a02e358447fa87a8-13"></a>  <span class="o">]</span>
</pre>
<p>And adding CSS for the <tt class="docutils literal"><span class="pre">.resource-delta</span></tt> in the <tt class="docutils literal">scss/overbots.scss</tt> file just under the <tt class="docutils literal"><span class="pre">.resource-value</span></tt> declaration of:</p>
<pre class="code scss"><a name="rest_code_3c3bd0d87bd643ff981e305498a6aa7b-1"></a><span class="nc">.resource-delta</span> <span class="p">{</span>
<a name="rest_code_3c3bd0d87bd643ff981e305498a6aa7b-2"></a>  <span class="nt">display</span><span class="nd">:</span> <span class="nt">flex</span><span class="o">;</span>
<a name="rest_code_3c3bd0d87bd643ff981e305498a6aa7b-3"></a>  <span class="nt">flex</span><span class="nd">:</span> <span class="nt">1</span><span class="o">;</span>
<a name="rest_code_3c3bd0d87bd643ff981e305498a6aa7b-4"></a>  <span class="nt">font-style</span><span class="nd">:</span> <span class="nt">italic</span><span class="o">;</span>
<a name="rest_code_3c3bd0d87bd643ff981e305498a6aa7b-5"></a>  <span class="nt">padding-left</span><span class="nd">:</span> <span class="nt">8px</span><span class="o">;</span>
<a name="rest_code_3c3bd0d87bd643ff981e305498a6aa7b-6"></a><span class="p">}</span>
</pre>
<p>And lastly to get the cache cleared as needed, let's make a helper function at the bottom of <tt class="docutils literal">src/overbots_resource.ml</tt> to do that:</p>
<pre class="code ocaml"><a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-1"></a><span class="k">let</span> <span class="n">init_cache</span> <span class="o">=</span> <span class="o">{</span>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-2"></a>  <span class="n">transformers</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-3"></a>  <span class="n">resource_deltas</span> <span class="o">=</span> <span class="n">init_resources_values</span><span class="o">;</span>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-4"></a><span class="o">}</span>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-5"></a>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-6"></a><span class="k">let</span> <span class="n">reset_cache</span> <span class="n">model</span> <span class="o">=</span>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-7"></a>  <span class="k">let</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">init_cache</span> <span class="k">in</span>
<a name="rest_code_dfaa5b1f960847e8badcf38bec1952cf-8"></a>  <span class="o">{</span><span class="n">model</span> <span class="k">with</span> <span class="n">cache</span><span class="o">}</span>
</pre>
<p>May as well update <tt class="docutils literal">init</tt> to use it:</p>
<pre class="code ocaml"><a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-1"></a><span class="k">let</span> <span class="n">init</span> <span class="bp">()</span> <span class="o">=</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-2"></a>  <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="o">{</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-3"></a>    <span class="n">start_realtime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-4"></a>    <span class="n">current_realtime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-5"></a>    <span class="n">gametime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-6"></a>    <span class="n">msgs</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-7"></a>    <span class="n">resource_values</span> <span class="o">=</span> <span class="nn">Overbots_resource</span><span class="p">.</span><span class="n">init_resources_values</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-8"></a>    <span class="n">bool_flags</span> <span class="o">=</span> <span class="n">init_bool_flags</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-9"></a>    <span class="n">int_flags</span> <span class="o">=</span> <span class="n">init_int_flags</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-10"></a>    <span class="n">float_flags</span> <span class="o">=</span> <span class="n">init_float_flags</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-11"></a>    <span class="n">cache</span> <span class="o">=</span> <span class="nn">Overbots_transformers</span><span class="p">.</span><span class="n">init_cache</span><span class="o">;</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-12"></a>  <span class="o">}</span> <span class="k">in</span>
<a name="rest_code_38bdf855f13e4ec09ef9df28f5eed58a-13"></a>  <span class="o">(</span><span class="n">model</span><span class="o">,</span> <span class="nn">Cmd</span><span class="p">.</span><span class="n">none</span><span class="o">)</span>
</pre>
<p>And let's call it from the action performer in <tt class="docutils literal">src/overbots_actions.ml</tt> where I changed <tt class="docutils literal">perform_actions</tt> to be:</p>
<pre class="code ocaml"><a name="rest_code_007eb2ce8d9e44639acf3dbc2ddf1847-1"></a><span class="k">let</span> <span class="n">perform_actions</span> <span class="n">model</span> <span class="n">actions</span> <span class="o">=</span>
<a name="rest_code_007eb2ce8d9e44639acf3dbc2ddf1847-2"></a>  <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="n">perform_action</span> <span class="n">model</span> <span class="n">actions</span>
<a name="rest_code_007eb2ce8d9e44639acf3dbc2ddf1847-3"></a>  <span class="o">|&gt;</span> <span class="n">reset_cache</span>
</pre>
<p>And let's get unfolding the solar panels to generate power, so I changed <tt class="docutils literal">button_actions</tt> in <tt class="docutils literal">src/overbots_buttons.ml</tt> to be:</p>
<pre class="code ocaml"><a name="rest_code_41aa6a237c81459aaf952d9eb1bfb9fa-1"></a><span class="k">let</span> <span class="n">button_actions</span> <span class="o">_</span><span class="n">model</span> <span class="o">=</span> <span class="k">function</span>
<a name="rest_code_41aa6a237c81459aaf952d9eb1bfb9fa-2"></a>  <span class="o">|</span> <span class="nc">UnfoldSolarPanels</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nc">ActionSetFloatFlag</span> <span class="o">(</span><span class="nc">BasicSolarPanelSelfGeneration</span><span class="o">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">);</span> <span class="nc">ActionSetBoolFlag</span> <span class="nc">SolarPanelsGenerating</span><span class="o">;</span> <span class="nc">ActionClearBoolFlag</span> <span class="nc">SolarPanelsReadyToUnfold</span><span class="o">;</span> <span class="nc">ActionAddMsg</span> <span class="s2">"Energy is now being generated, now to acquire simple minerals by drilling"</span><span class="o">]</span>
<a name="rest_code_41aa6a237c81459aaf952d9eb1bfb9fa-3"></a>  <span class="o">|</span> <span class="nc">DeployDrill</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nc">ActionSetBoolFlag</span> <span class="nc">DrillDeployed</span><span class="o">;</span> <span class="nc">ActionAddMsg</span> <span class="s2">"Now that I've started acquiring resources I need to activate my internal refineries to prepare the resources for use"</span><span class="o">]</span>
</pre>
<p>At this point the basics of everything needed is done.  Can now start adding new functionality, new buttons, resources, everything as desired.  I've already tweaked a couple of numbers but nothing big.  More is soon-coming.</p>
</div>
<div class="section" id="result">
<h2>Result</h2>
<p>You can access the output of this post at <a class="reference external" href="dev.html">Overbots Pt5</a>.</p>
<p>And the source is on the <a class="reference external" href="https://github.com/OvermindDL1/overbots/tree/pt5">Overbots Github Pt5</a>.</p>
<p>Check out this entire series via the <a class="reference external" href="../../tags/overbots/">Overbots tag</a>.</p>
</div>
</div>
            </div>
            
    <div class="mdl-grid mdl-card__supporting-text mdl-card--border metadata">
        <div class="mdl-cell mdl-cell--1-col">
          <button class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored mdl-js-ripple-effect">
            
            <img src="https://www.gravatar.com/avatar/5575f10ccc57e0608827fd332448225b" style="width: 100%; height: 100%;"></button>
        </div>
        <div class="mdl-grid mdl-cell mdl-cell--9-col">
            <span class="mdl-cell mdl-cell--12-col site-post__author no-margin-bottom">
                OvermindDL1
            </span>
            <span class="mdl-cell mdl-cell--12-col site-post__date">
                <time class="published dt-published" datetime="2017-05-18T06:32:30-06:00" itemprop="datePublished" title="2017-05-18 06:32">2017-05-18 06:32
                </time></span>
        </div>
        <span class="mdl-cell mdl-cell--2-col site-post__total-comment">
                
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/bucklescript-tea-game-overbots-pt5-transformation-of-resources.html">Comments</a>


        </span>
    </div>

            
    <div class="mdl-grid mdl-card__actions mdl-card--border">
        
              <a class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored mdl-button--accent site-post__tag" rel="tag" title="bucklescript" href="../../tags/bucklescript/">bucklescript</a>
              <a class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored mdl-button--accent site-post__tag" rel="tag" title="bucklescript-tea" href="../../tags/bucklescript-tea/">bucklescript-tea</a>
              <a class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored mdl-button--accent site-post__tag" rel="tag" title="overbots" href="../../tags/overbots/">overbots</a>

        <div class="section-spacer"></div>
        
    <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored mdl-button--accent site-post__source-link" rel="tag" title="Source" href="index.rst">Source</a>

        

    </div>

            <div class="mdl-color-text--primary-contrast mdl-card__supporting-text comments hidden-print">
                <h2>Comments</h2>
                
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="overblogdl1",
            disqus_url="http://blog.overminddl1.com/posts/bucklescript-tea-game-overbots-pt5-transformation-of-resources/",
        disqus_title="Bucklescript-Tea Game OverBots Pt.5 - Transformation of Resources",
        disqus_identifier="cache/posts/bucklescript-tea-game-overbots-pt5-transformation-of-resources.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


            </div>
            

        </article>
</div>
    
        <nav class="site-navigation hidden-print pager mdl-cell mdl-cell--12-col"><a href="../bucklescript-tea-game-overbots-pt4-actions/" class="site-navigation__button site-navigation__previous" rel="prev" title="Bucklescript-Tea Game OverBots Pt.4 - Actions">
                  <button class="mdl-button mdl-js-button mdl-button--icon mdl-js-ripple-effect">
                    <i class="material-icons" role="presentation">arrow_back</i>
                  </button>
                  Previous post
                </a>
            <div class="section-spacer"></div>
                <a href="../bucklescript-tea-game-overbots-pt6-serialization/" class="site-navigation__button site-navigation__next" rel="next" title="Bucklescript-Tea Game OverBots Pt.6 - Serialization">
                  Next post
                  <button class="mdl-button mdl-js-button mdl-button--icon mdl-js-ripple-effect">
                    <i class="material-icons" role="presentation">arrow_forward</i>
                  </button>
                </a>
        </nav><script>var disqus_shortname="overblogdl1";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>

            
        <footer id="footer" class="site-footer
mdl-mega-footer
        ">
            Contents © 2019 <a href="mailto:overminddl1@overminddl1.com">OvermindDL1</a> 
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"></a>
<br>
This work by
<a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.overminddl1.com/" property="cc:attributionName" rel="cc:attributionURL">
    http://blog.overminddl1.com/
</a>
is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
    Creative Commons Attribution-NonCommercial 4.0 International License
</a>
.
<br>
Permissions beyond the scope of this license may be available at
<a xmlns:cc="http://creativecommons.org/ns#" href="http://blog.overminddl1.com/" rel="cc:morePermissions">
    http://blog.overminddl1.com/
</a>
.

            
        <script>
            window.klipse_settings = {
                codemirror_options_in: {
                    lineWrapping: true,
                    autoCloseBrackets: true
                },
                codemirror_options_out: {
                    lineWrapping: true
                },
                beautify_strings: true,
                selector: '.language-klipse',
                selector_eval_js: '.language-klipse-eval-js',
                selector_jsx: '.language-klipse-jsx',
                selector_render_jsx: '.language-render-jsx',
                selector_es2017: '.language-es2017',
                selector_brainfuck: '.language-brainfuck',
                selector_transpile_jsx: '.language-transpile-jsx',
                selector_eval_php: '.language-klipse-eval-php',
                selector_eval_markdown: '.language-klipse-markdown',
                selector_eval_lambdaway: '.language-klipse-lambdaway',
                selector_eval_python_client: '.language-klipse-eval-python, .language-eval-python',
                selector_eval_html: '.language-klipse-html',
                selector_sql: '.language-klipse-sql',
                selector_eval_ruby: '.language-klipse-eval-ruby',
                selector_eval_scheme: '.language-klipse-scheme',
                selector_eval_cpp: '.language-klipse-eval-cpp',
                selector_google_charts: '.language-google-chart',
                selector_plot: '.language-plot',
                selector_oblivion: '.language-oblivion',
                selector_lua: '.language-klipse-lua',
                selector_js: '.language-klipse-js',
                selector_eval_ocaml: '.language-klipse-eval-ocaml',
                selector_transpile_ocaml: '.language-transpile-ocaml',
                selector_transpile_reason_3: '.language-transpile-reason',
                selector_transpile_reason_3_to_ocaml: '.language-transpile-reason-to-ocaml',
                selector_eval_reason_3: '.language-klipse-reason',
                selector_ocaml_to_reason: '.language-ocaml-to-reason',
                selector_reagent: '.language-reagent',
            };
        </script><script src="https://storage.googleapis.com/app.klipse.tech/plugin_prod/js/klipse_plugin.min.js?v=7.2.4"></script></footer></main>
</div>
    
        <script src="//storage.googleapis.com/code.getmdl.io/1.1.3/material.min.js"></script><script src="//code.jquery.com/jquery-2.1.4.min.js" type="text/javascript"></script><script src="../../assets/colorbox/js/jquery.colorbox-min.js" type="text/javascript"></script><script>$('.thumbnails a').colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script>
</body>
</html>
